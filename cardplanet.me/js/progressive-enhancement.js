/**
 * Ê∏êËøõÂºèÂ¢ûÂº∫ËÑöÊú¨
 * Âú®ÂéüÊúâÂü∫Á°Ä‰∏äÊ∑ªÂä†ÊÄßËÉΩ‰ºòÂåñÔºå‰∏çÁ†¥ÂùèÁé∞ÊúâÂäüËÉΩ
 */

class ProgressiveEnhancement {
    constructor() {
        this.optimizedImagesAvailable = false;
        this.modernFormatsSupported = {
            avif: false,
            webp: false
        };
        
        this.init();
    }

    async init() {
        console.log('üöÄ ÂêØÂä®Ê∏êËøõÂºèÂ¢ûÂº∫...');
        
        // Ê£ÄÊµãÁé∞‰ª£Ê†ºÂºèÊîØÊåÅ
        await this.detectFormatSupport();
        
        // Ê£ÄÊü•‰ºòÂåñÂõæÁâáÊòØÂê¶ÂèØÁî®
        await this.checkOptimizedImages();
        
        // Â¢ûÂº∫Áé∞ÊúâÂõæÁâá
        this.enhanceExistingImages();
        
        // Ê∑ªÂä†ÊÄßËÉΩÁõëÊéß
        this.addPerformanceMonitoring();
        
        // Ê∑ªÂä†ÊáíÂä†ËΩΩ
        this.addLazyLoading();
        
        console.log('‚úÖ Ê∏êËøõÂºèÂ¢ûÂº∫ÂÆåÊàê', {
            optimizedAvailable: this.optimizedImagesAvailable,
            avif: this.modernFormatsSupported.avif,
            webp: this.modernFormatsSupported.webp
        });
    }

    async detectFormatSupport() {
        // Ê£ÄÊµã AVIF
        this.modernFormatsSupported.avif = await this.checkImageSupport(
            'data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAAB0AAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAIAAAACAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQ0MAAAAABNjb2xybmNseAACAAIAAYAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAACVtZGF0EgAKCBgABogQEAwgMg8f8D///8WfhwB8+ErK42A='
        );

        // Ê£ÄÊµã WebP
        this.modernFormatsSupported.webp = await this.checkImageSupport(
            'data:image/webp;base64,UklGRjoAAABXRUJQVlA4IC4AAACyAgCdASoCAAIALmk0mk0iIiIiIgBoSygABc6WWgAA/veff/0PP8bA//LwYAAA'
        );
    }

    checkImageSupport(src) {
        return new Promise((resolve) => {
            const img = new Image();
            img.onload = () => resolve(true);
            img.onerror = () => resolve(false);
            img.src = src;
        });
    }

    async checkOptimizedImages() {
        try {
            const response = await fetch('optimized-images/manifest.json');
            if (response.ok) {
                this.optimizedImagesAvailable = true;
                this.optimizedManifest = await response.json();
            }
        } catch (error) {
            console.log('üìã ‰ºòÂåñÂõæÁâáÊ∏ÖÂçï‰∏çÂèØÁî®Ôºå‰ΩøÁî®ÂéüÂßãÂõæÁâá');
        }
    }

    enhanceExistingImages() {
        // Â¢ûÂº∫Áé∞ÊúâÁöÑimgÂÖÉÁ¥†
        const images = document.querySelectorAll('img[src*="thumbnails/"]');
        
        images.forEach(img => {
            this.enhanceImage(img);
        });

        // ÁõëÂê¨Âä®ÊÄÅÊ∑ªÂä†ÁöÑÂõæÁâá
        const observer = new MutationObserver(mutations => {
            mutations.forEach(mutation => {
                mutation.addedNodes.forEach(node => {
                    if (node.nodeType === 1) {
                        const imgs = node.querySelectorAll ? node.querySelectorAll('img') : [];
                        imgs.forEach(img => this.enhanceImage(img));
                    }
                });
            });
        });

        observer.observe(document.body, { childList: true, subtree: true });
    }

    enhanceImage(img) {
        if (img.dataset.enhanced === 'true') return;
        
        img.dataset.enhanced = 'true';
        const originalSrc = img.src;
        
        // Ê∑ªÂä†ÂõûÈÄÄÊú∫Âà∂
        img.addEventListener('error', () => {
            if (img.src !== originalSrc) {
                console.log(`üîÑ ÂõæÁâáÂõûÈÄÄ: ${img.src} ‚Üí ${originalSrc}`);
                img.src = originalSrc;
            }
        });

        // Â¶ÇÊûúÊúâ‰ºòÂåñÂõæÁâáÂèØÁî®ÔºåÂ∞ùËØï‰ΩøÁî®
        if (this.optimizedImagesAvailable) {
            const optimizedSrc = this.getOptimizedImageSrc(originalSrc);
            if (optimizedSrc && optimizedSrc !== originalSrc) {
                // È¢ÑÂä†ËΩΩ‰ºòÂåñÂõæÁâá
                const testImg = new Image();
                testImg.onload = () => {
                    img.src = optimizedSrc;
                    console.log(`‚úÖ ‰ΩøÁî®‰ºòÂåñÂõæÁâá: ${optimizedSrc}`);
                };
                testImg.onerror = () => {
                    console.log(`‚ö†Ô∏è ‰ºòÂåñÂõæÁâá‰∏çÂèØÁî®Ôºå‰øùÊåÅÂéüÂõæ: ${originalSrc}`);
                };
                testImg.src = optimizedSrc;
            }
        }

        // Ê∑ªÂä†ÊáíÂä†ËΩΩÂ±ûÊÄß
        if (!this.isInViewport(img)) {
            img.loading = 'lazy';
        }

        // Ê∑ªÂä†Ê∏êÂÖ•ÊïàÊûú
        this.addFadeInEffect(img);
    }

    getOptimizedImageSrc(originalSrc) {
        if (!this.optimizedImagesAvailable) return null;

        // ‰ªéÂéüÂßãË∑ØÂæÑÊèêÂèñÊñá‰ª∂Âêç
        const filename = originalSrc.split('/').pop();
        const basename = filename.replace(/\.(png|jpg|jpeg)$/i, '');
        
        // Êò†Â∞ÑÂà∞‰ºòÂåñÂõæÁâá
        const nameMapping = {
            'floral_flex_Chinese_Artistry_style_best': 'floral_flex_Chinese_Artistry',
            'sydney_sweeney_Editorial_Soft_style': 'sydney_sweeney_Editorial_Soft',
            'spacecore_drawstring_jean_Cosmic_Empire_style': 'spacecore_drawstring_Cosmic_Empire',
            'depop_2005_closet_Pin_Board_style': 'depop_2005_closet_Pin_Board',
            'no_try_summer_look_Minimal_style': 'no_try_summer_look_Minimal',
            'lollapalooza_street_Luxe_Print_style': 'lollapalooza_street_Luxe_Print',
            'lolitics_Bubble_Fresh_style': 'lolitics_Bubble_Fresh',
            'pucci_swirls_genz_Geometric_Symphony_style': 'pucci_swirls_genz_Geometric_Symphony',
            'genz_career_shift_System_Clean_style': 'genz_career_shift_System_Clean',
            'brainrot_Impressionist_ Soft_style': 'brainrot_Impressionist_Soft',
            'side_hustle_brand_Woven_Texture_style': 'side_hustle_brand_Woven_Texture',
            'matcha_man_Fluid_Zen_style': 'matcha_man_Fluid_Zen'
        };

        const mappedName = nameMapping[basename] || basename;
        
        // ÈÄâÊã©ÊúÄ‰Ω≥Ê†ºÂºè
        let format = 'webp'; // ÈªòËÆ§WebP
        if (this.modernFormatsSupported.avif) {
            format = 'avif';
        } else if (!this.modernFormatsSupported.webp) {
            return null; // ‰∏çÊîØÊåÅÁé∞‰ª£Ê†ºÂºèÔºå‰ΩøÁî®ÂéüÂõæ
        }

        return `optimized-images/${format}/${mappedName}.${format}`;
    }

    isInViewport(element) {
        const rect = element.getBoundingClientRect();
        return (
            rect.top >= 0 &&
            rect.left >= 0 &&
            rect.bottom <= window.innerHeight &&
            rect.right <= window.innerWidth
        );
    }

    addFadeInEffect(img) {
        if (img.complete && img.naturalHeight !== 0) {
            // ÂõæÁâáÂ∑≤Âä†ËΩΩ
            img.style.opacity = '1';
        } else {
            // ÂõæÁâáÊ≠£Âú®Âä†ËΩΩ
            img.style.opacity = '0';
            img.style.transition = 'opacity 0.3s ease';
            
            img.addEventListener('load', () => {
                img.style.opacity = '1';
            }, { once: true });
        }
    }

    addLazyLoading() {
        // ‰∏∫ÈùûÈ¶ñÂ±èÂõæÁâáÊ∑ªÂä†ÊáíÂä†ËΩΩ
        if ('IntersectionObserver' in window) {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        if (img.dataset.src) {
                            img.src = img.dataset.src;
                            img.removeAttribute('data-src');
                        }
                        observer.unobserve(img);
                    }
                });
            }, { rootMargin: '50px' });

            // ËßÇÂØüÊâÄÊúâÊú™Âú®ËßÜÂè£‰∏≠ÁöÑÂõæÁâá
            document.querySelectorAll('img').forEach(img => {
                if (!this.isInViewport(img) && img.src) {
                    img.dataset.src = img.src;
                    img.src = this.createPlaceholder(img.width || 320, img.height || 481);
                    observer.observe(img);
                }
            });
        }
    }

    createPlaceholder(width, height) {
        const svg = `
            <svg width="${width}" height="${height}" xmlns="http://www.w3.org/2000/svg">
                <rect width="100%" height="100%" fill="#f0f0f0"/>
                <circle cx="50%" cy="50%" r="20" fill="#e0e0e0"/>
            </svg>
        `;
        return `data:image/svg+xml;base64,${btoa(svg)}`;
    }

    addPerformanceMonitoring() {
        // ÁõëÊéßÂÖ≥ÈîÆÊÄßËÉΩÊåáÊ†á
        if ('PerformanceObserver' in window) {
            const observer = new PerformanceObserver((list) => {
                for (const entry of list.getEntries()) {
                    switch (entry.entryType) {
                        case 'paint':
                            if (entry.name === 'first-contentful-paint') {
                                console.log(`üé® FCP: ${entry.startTime.toFixed(1)}ms`);
                            }
                            break;
                        case 'largest-contentful-paint':
                            console.log(`üñºÔ∏è LCP: ${entry.startTime.toFixed(1)}ms`);
                            break;
                    }
                }
            });

            observer.observe({ entryTypes: ['paint', 'largest-contentful-paint'] });
        }
    }

    // Ê∑ªÂä†ÂÖ≥ÈîÆCSS‰ºòÂåñ
    addCriticalCSS() {
        if (document.querySelector('[data-critical-css]')) return;

        const criticalCSS = `
            img { 
                transition: opacity 0.3s ease;
            }
            .loading-placeholder {
                background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
                background-size: 200% 100%;
                animation: shimmer 1.5s infinite;
            }
            @keyframes shimmer {
                0% { background-position: 200% 0; }
                100% { background-position: -200% 0; }
            }
        `;

        const style = document.createElement('style');
        style.textContent = criticalCSS;
        style.setAttribute('data-critical-css', 'true');
        document.head.appendChild(style);
    }
}

// Á°Æ‰øùÂú®È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéËøêË°å
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
        window.progressiveEnhancement = new ProgressiveEnhancement();
    });
} else {
    window.progressiveEnhancement = new ProgressiveEnhancement();
}